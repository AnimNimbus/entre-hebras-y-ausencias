<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>AR con Video y Modelo 3D</title>
  <style>
    body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; background: black; }
    #startButton, #videoButton {
      z-index: 10;
      padding: 15px 30px;
      font-size: 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
    }
    #startButton { top: 20px; }
    #videoButton { bottom: 20px; display: none; font-size: 24px; padding: 20px 40px; }
    #instructionText {
      position: absolute;
      top: 80px;
      width: 100%;
      text-align: center;
      z-index: 10;
      font-size: 24px;
      font-weight: bold;
      padding: 15px;
      background: rgba(0,0,0,0.5);
      color: white;
      display: none;
    }
    video#mainVideo {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      display: none;
      z-index: 20;
    }
  </style>
</head>
<body>
  <button id="startButton">Iniciar Cámara</button>
  <div id="instructionText">Junta los 3 cuadros</div>
  <button id="videoButton">No todo es lo que parece</button>
  <video id="mainVideo" src="videos/victima.mp4"></video>

  <script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.155/build/three.module.js';
    import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.155/examples/jsm/loaders/GLTFLoader.js';
    import { ARButton } from 'https://cdn.jsdelivr.net/npm/three@0.155/examples/jsm/webxr/ARButton.js';

    const startButton = document.getElementById("startButton");
    const instructionText = document.getElementById("instructionText");
    const videoButton = document.getElementById("videoButton");
    const mainVideo = document.getElementById("mainVideo");

    let renderer, scene, camera, modelo;
    let hitTestSource = null;
    let localSpace = null;
    let reticle;

    startButton.addEventListener("click", () => {
      startButton.style.display = "none";
      instructionText.style.display = "block";
      videoButton.style.display = "block";

      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.xr.enabled = true;
      document.body.appendChild(renderer.domElement);

      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

      const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
      scene.add(light);

      const loader = new GLTFLoader();
      loader.load("models/pose_final_cuadro.glb", (gltf) => {
        modelo = gltf.scene;
        modelo.scale.set(0.5, 0.5, 0.5);
        modelo.visible = false; 
        scene.add(modelo);
      });

      // retícula para indicar posición
      const ringGeo = new THREE.RingGeometry(0.1, 0.11, 32).rotateX(-Math.PI/2);
      const ringMat = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
      reticle = new THREE.Mesh(ringGeo, ringMat);
      reticle.matrixAutoUpdate = false;
      reticle.visible = false;
      scene.add(reticle);

      const arButton = ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] });
      document.body.appendChild(arButton);

      renderer.setAnimationLoop((timestamp, frame) => {
        if (frame) {
          const session = renderer.xr.getSession();
          if (!hitTestSource) {
            session.requestReferenceSpace('viewer').then((space) => {
              session.requestHitTestSource({ space }).then((source) => {
                hitTestSource = source;
              });
            });
            session.addEventListener("end", () => {
              hitTestSource = null;
              localSpace = null;
            });
          }
          if (hitTestSource) {
            const refSpace = renderer.xr.getReferenceSpace();
            const hitTestResults = frame.getHitTestResults(hitTestSource);
            if (hitTestResults.length > 0) {
              const pose = hitTestResults[0].getPose(refSpace);
              reticle.visible = true;
              reticle.matrix.fromArray(pose.transform.matrix);

              // Colocar el modelo en la retícula la primera vez que se activa
              if (modelo && !modelo.visible && mainVideo.style.display === "none") {
                modelo.visible = true;
                modelo.position.setFromMatrixPosition(reticle.matrix);
              }
            } else {
              reticle.visible = false;
            }
          }
        }
        renderer.render(scene, camera);
      });
    });

    // botón de video
    videoButton.addEventListener("click", () => {
      instructionText.style.display = "none";
      videoButton.style.display = "none";

      mainVideo.style.display = "block";
      mainVideo.play();

      mainVideo.onended = () => {
        mainVideo.style.display = "none";
        instructionText.style.display = "block";
        if (modelo) modelo.visible = true;
      };
    });
  </script>
</body>
</html>
