<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
  <title>Experiencia AR</title>
  <style>
    html, body {
      margin:0; padding:0;
      height:100%; width:100%;
      overflow:hidden;
      background:#000; color:#fff;
      font-family:Arial, sans-serif;
    }
    #overlay {
      position:absolute; inset:0;
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      background:rgba(0,0,0,0.7);
      z-index:10; gap:15px; text-align:center;
    }
    #btnStart {
      background:#ff3b30; color:#fff;
      border:none; padding:14px 20px;
      border-radius:10px; font-size:18px;
    }
    #texto {
      position:absolute; top:20px; left:0; right:0;
      text-align:center;
      font-size:22px; font-weight:bold; color:#00ffcc;
      display:none; text-shadow:0 0 6px #000;
      z-index:5;
    }
    video.hidden { display:none; }
  </style>

  <!-- Librerías de MindAR + ThreeJS -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar/dist/mindar-image-three.prod.js"></script>
</head>
<body>
  <!-- Overlay inicial -->
  <div id="overlay">
    <div>Para iniciar la experiencia, permite el uso de la cámara.</div>
    <button id="btnStart">Iniciar cámara</button>
  </div>

  <!-- Texto que aparece tras activar cámara -->
  <div id="texto">Junta los 3 cuadros</div>

  <!-- Videos ocultos -->
  <video id="videoAgresor" class="hidden" src="videos/agresor.mp4" playsinline></video>
  <video id="videoVictima" class="hidden" src="videos/victima.mp4" playsinline></video>
  <video id="videoTestigo" class="hidden" src="videos/testigo.mp4" playsinline></video>

  <script>
    const btn = document.getElementById("btnStart");
    const overlay = document.getElementById("overlay");
    const texto = document.getElementById("texto");

    btn.addEventListener("click", async () => {
      overlay.style.display = "none";   
      texto.style.display = "block";    
      startAR(); 
    });

    async function startAR() {
      const mindarThree = new window.MINDAR.IMAGE.MindARThree({
        container: document.body,
        imageTargetSrc: "targets/cuadros.mind",
      });

      const {renderer, scene, camera} = mindarThree;

      // Cargar videos
      const vAgresor = document.getElementById("videoAgresor");
      const vVictima = document.getElementById("videoVictima");
      const vTestigo = document.getElementById("videoTestigo");

      const texAgresor = new THREE.VideoTexture(vAgresor);
      const texVictima = new THREE.VideoTexture(vVictima);
      const texTestigo = new THREE.VideoTexture(vTestigo);

      const planeA = new THREE.Mesh(new THREE.PlaneGeometry(1, 0.6), new THREE.MeshBasicMaterial({map: texAgresor}));
      const planeV = new THREE.Mesh(new THREE.PlaneGeometry(1, 0.6), new THREE.MeshBasicMaterial({map: texVictima}));
      const planeT = new THREE.Mesh(new THREE.PlaneGeometry(1, 0.6), new THREE.MeshBasicMaterial({map: texTestigo}));

      const anchor0 = mindarThree.addAnchor(0); // agresor
      const anchor1 = mindarThree.addAnchor(1); // victima
      const anchor2 = mindarThree.addAnchor(2); // testigo

      anchor0.group.add(planeA);
      anchor1.group.add(planeV);
      anchor2.group.add(planeT);

      let detected = [false, false, false];

      function resetVideos() {
        [vAgresor, vVictima, vTestigo].forEach(v => {
          v.pause();
          v.currentTime = 0;
        });
      }

      function checkAll() {
        if (detected.every(d => d)) {
          [vAgresor, vVictima, vTestigo].forEach(v => {
            v.currentTime = 0;
            v.play();
          });
        } else {
          resetVideos();
        }
      }

      anchor0.onTargetFound = () => { detected[0] = true; checkAll(); };
      anchor0.onTargetLost  = () => { detected[0] = false; checkAll(); };
      anchor1.onTargetFound = () => { detected[1] = true; checkAll(); };
      anchor1.onTargetLost  = () => { detected[1] = false; checkAll(); };
      anchor2.onTargetFound = () => { detected[2] = true; checkAll(); };
      anchor2.onTargetLost  = () => { detected[2] = false; checkAll(); };

      await mindarThree.start();
      renderer.setAnimationLoop(() => {
        renderer.render(scene, camera);
      });
    }
  </script>
</body>
</html>
