<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Detección de 3 cuadros con MindAR</title>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar/dist/mindar-image-three.prod.js"></script>
  <script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.155/build/three.module.js';

    document.addEventListener("DOMContentLoaded", () => {
      const mindarThree = new window.MINDAR.IMAGE.MindARThree({
        container: document.body,
        imageTargetSrc: [
          "targets/victima.mind",
          "targets/agresor.mind",
          "targets/testigo.mind"
        ]
      });

      const {renderer, scene, camera} = mindarThree;

      const anchorVictima = mindarThree.addAnchor(0);
      const anchorAgresor = mindarThree.addAnchor(1);
      const anchorTestigo = mindarThree.addAnchor(2);

      let visibles = {victima: false, agresor: false, testigo: false};
      let videoActivado = false;

      function checkAllVisible() {
        return visibles.victima && visibles.agresor && visibles.testigo;
      }

      // === DETECCIÓN DE CADA CUADRO ===
      anchorVictima.onTargetFound = () => {visibles.victima = true; if (checkAllVisible()) activarVideo();}
      anchorAgresor.onTargetFound = () => {visibles.agresor = true; if (checkAllVisible()) activarVideo();}
      anchorTestigo.onTargetFound = () => {visibles.testigo = true; if (checkAllVisible()) activarVideo();}

      anchorVictima.onTargetLost = () => {visibles.victima = false;}
      anchorAgresor.onTargetLost = () => {visibles.agresor = false;}
      anchorTestigo.onTargetLost = () => {visibles.testigo = false;}

      async function start() {
        await mindarThree.start();
        renderer.setAnimationLoop(() => {
          renderer.render(scene, camera);
        });
      }
      start();

      function activarVideo(){
        if (videoActivado) return;
        videoActivado = true;

        const video = document.getElementById("video");
        video.style.display = "block";
        video.play();

        video.onended = () => {
          video.style.display = "none";
          document.getElementById("modelo").style.display = "block";
        };
      }
    });
  </script>
  <style>
    body {margin:0; overflow:hidden; background:black;}
    video {
      position: absolute;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      display: none;
      z-index: 10;
    }
    model-viewer {
      position: absolute;
      width: 100%;
      height: 100%;
      display: none;
      z-index: 5;
    }
  </style>
  <!-- model-viewer -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
</head>
<body>
  <!-- Video que se muestra cuando se detecten los 3 cuadros -->
  <video id="video" src="videos/victima.mp4" playsinline></video>

  <!-- Modelo 3D que aparece al terminar el video -->
  <model-viewer id="modelo"
    src="modelos/escena.glb"
    camera-controls
    disable-zoom
    auto-rotate="false"
    ar
    style="display:none;">
  </model-viewer>
</body>
</html>
