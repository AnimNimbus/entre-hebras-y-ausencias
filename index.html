<!DOCTYPE html>
<html>
  <head>
    <title>Videos sincronizados con mind-ar</title>
    <script src="https://cdn.jsdelivr.net/npm/aframe@1.4.0/dist/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
      body { margin: 0; overflow: hidden; }
      #startButton {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 12px 20px;
        background: #222;
        color: #fff;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        z-index: 10;
      }
    </style>
  </head>
  <body>
    <button id="startButton">Iniciar Cámara</button>

    <a-scene
      mindar-image="imageTargetSrc: ./victima.mind, ./agresor.mind, ./testigo.mind"
      embedded
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
    >
      <a-assets>
        <video id="victimaVideo" src="victima.mp4" preload="auto" playsinline webkit-playsinline crossorigin="anonymous"></video>
        <video id="agresorVideo" src="agresor.mp4" preload="auto" playsinline webkit-playsinline crossorigin="anonymous"></video>
        <video id="testigoVideo" src="testigo.mp4" preload="auto" playsinline webkit-playsinline crossorigin="anonymous"></video>
      </a-assets>

      <!-- Target víctima -->
      <a-entity mindar-image-target="targetIndex: 0">
        <a-plane id="victimaPlane" src="#victimaVideo" position="0 0 0" height="1" width="1.5" visible="false"></a-plane>
      </a-entity>

      <!-- Target agresor -->
      <a-entity mindar-image-target="targetIndex: 1">
        <a-plane id="agresorPlane" src="#agresorVideo" position="0 0 0" height="1" width="1.5" visible="false"></a-plane>
      </a-entity>

      <!-- Target testigo -->
      <a-entity mindar-image-target="targetIndex: 2">
        <a-plane id="testigoPlane" src="#testigoVideo" position="0 0 0" height="1" width="1.5" visible="false"></a-plane>
      </a-entity>

      <a-camera position="0 0 0"></a-camera>
    </a-scene>

    <script>
      document.querySelector('#startButton').addEventListener('click', () => {
        document.querySelector('#startButton').style.display = 'none';
        document.querySelector('a-scene').components['mindar-image'].start();

        const planes = {
          0: document.querySelector('#victimaPlane'),
          1: document.querySelector('#agresorPlane'),
          2: document.querySelector('#testigoPlane')
        };

        const videos = {
          0: document.querySelector('#victimaVideo'),
          1: document.querySelector('#agresorVideo'),
          2: document.querySelector('#testigoVideo')
        };

        const sceneEl = document.querySelector('a-scene');
        let visibles = {0: false, 1: false, 2: false};
        let started = false; // para evitar que se reinicie varias veces

        sceneEl.addEventListener("targetFound", (e) => {
          const idx = e.detail.targetIndex;
          visibles[idx] = true;

          // cuando los 3 estén visibles a la vez y aún no haya iniciado
          if (visibles[0] && visibles[1] && visibles[2] && !started) {
            started = true;
            // mostrar todos y reiniciar videos
            [0,1,2].forEach(i => {
              planes[i].setAttribute("visible", true);
              videos[i].currentTime = 0;
              videos[i].loop = false; // no repetir
              videos[i].play();
            });
          }
        });

        sceneEl.addEventListener("targetLost", (e) => {
          const idx = e.detail.targetIndex;
          visibles[idx] = false;
        });
      });
    </script>
  </body>
</html>
