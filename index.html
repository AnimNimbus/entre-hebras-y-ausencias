<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>AR con cámara, video y GLB</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
      background: black;
    }

    /* Cámara en vivo */
    #camera {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      z-index: 1;
    }

    /* Cuadros de referencia */
    .cuadro {
      width: 100px;
      height: 100px;
      border: 3px solid yellow;
      position: absolute;
      z-index: 2;
    }
    #victima { top: 10%; left: 10%; }
    #agresor { top: 40%; left: 40%; }
    #testigo { bottom: 10%; right: 10%; }

    /* Video */
    #video {
      position: absolute;
      width: 80%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: none;
      z-index: 5;
    }

    /* Modelo 3D */
    model-viewer {
      position: absolute;
      width: 100%;
      height: 100%;
      display: none;
      z-index: 4;
    }
  </style>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
</head>
<body>
  <!-- Cámara -->
  <video id="camera" autoplay playsinline muted></video>

  <!-- Tres cuadros de referencia -->
  <div id="victima" class="cuadro"></div>
  <div id="agresor" class="cuadro"></div>
  <div id="testigo" class="cuadro"></div>

  <!-- Video -->
  <video id="video" src="videos/victima.mp4" playsinline></video>

  <!-- Modelo 3D -->
  <model-viewer id="modelo"
    src="modelos/escena.glb"
    camera-controls
    ar
    disable-pan="false"
    disable-zoom="false"
    auto-rotate="false">
  </model-viewer>

  <script>
    const camera = document.getElementById("camera");
    const video = document.getElementById("video");
    const modelo = document.getElementById("modelo");

    // Inicializar cámara trasera
    navigator.mediaDevices.getUserMedia({
      video: { facingMode: { exact: "environment" } }
    }).then(stream => {
      camera.srcObject = stream;
    }).catch(err => {
      alert("Error al acceder a la cámara: " + err);
    });

    // Función: verificar si un elemento está visible en pantalla
    function isVisible(el) {
      const rect = el.getBoundingClientRect();
      return (
        rect.top >= 0 &&
        rect.left >= 0 &&
        rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
        rect.right <= (window.innerWidth || document.documentElement.clientWidth)
      );
    }

    function checkAllVisible() {
      return (
        isVisible(document.getElementById("victima")) &&
        isVisible(document.getElementById("agresor")) &&
        isVisible(document.getElementById("testigo"))
      );
    }

    let triggered = false;

    function loop() {
      if (!triggered && checkAllVisible()) {
        triggered = true;

        // Mostrar y reproducir video
        video.style.display = "block";
        video.play();

        // Cuando termine el video → mostrar modelo 3D
        video.onended = () => {
          video.style.display = "none";
          modelo.style.display = "block";
        };
      }
      requestAnimationFrame(loop);
    }

    loop();
  </script>
</body>
</html>
